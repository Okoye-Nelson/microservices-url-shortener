events {
    worker_connections 1024;
}

http {
    upstream link-service {
        server link-service:8001;
    }

    upstream redirect-service {
        server redirect-service:8002;
    }

    upstream stats-service {
        server stats-service:8003;
    }

    # upstream notification-service {
    #     server notification-service:8004;
    # }

    # The frontend is not part of the Docker Compose setup, so this is not needed here.
    # upstream frontend {
    #     server frontend:80;
    # }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=redirect:10m rate=100r/s;

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint
        location /health {
            return 200 "OK";
            add_header Content-Type text/plain;
            add_header Access-Control-Allow-Origin *;
        }

        # Link generation service
        location /api/generate {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://link-service/generate;
            include /etc/nginx/conf.d/cors.conf; # Add CORS headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Link listing service
        location /api/links {
            limit_req zone=api burst=10 nodelay;
            proxy_pass http://link-service/links;
            include /etc/nginx/conf.d/cors.conf; # Add CORS headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Link deletion service
        location /api/delete {
            limit_req zone=api burst=10 nodelay; # This block will now handle /api/delete/{id}
            proxy_pass http://link-service/delete; # Pass the full path including the ID
            include /etc/nginx/conf.d/cors.conf; # Add CORS headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Redirect service (short URLs) - exclude health and api paths
        location ~ ^/(?!health|api)([a-zA-Z0-9]+)$ {
            limit_req zone=redirect burst=200 nodelay;
            proxy_pass http://redirect-service/redirect/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Stats service
        location /api/stats {
            limit_req zone=api burst=10 nodelay;
            proxy_pass http://stats-service/stats;
            include /etc/nginx/conf.d/cors.conf; # Add CORS headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # # Notification service
        # location /api/notifications {
        #     limit_req zone=api burst=5 nodelay;
        #     proxy_pass http://notification-service/notifications;
        #     include /etc/nginx/conf.d/cors.conf; # Add CORS headers
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }
    }
}
